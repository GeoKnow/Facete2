<!DOCTYPE html>
<html ng-app="Facete2">

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <title>Facete II</title>
	
    <!-- bower:css -->
	    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
	    <link rel="stylesheet" href="bower_components/jassa-ui-angular/jassa-ui-angular.css" />
	    <link rel="stylesheet" href="bower_components/jassa-ui-angular-openlayers/jassa-ui-angular-openlayers.css" />
	    <!-- endbower -->

	<link rel="stylesheet" href="bower_components/ng-grid-bower/ng-grid.css" />

<!--    <link rel="stylesheet" href="../../../target/release/repo/jassa-ui-angular.css" /> -->
	
    <script src="bower_components/jscache/cache.js"></script>

    <!-- bower:js -->
    <script src="bower_components/jquery/jquery.js"></script>
    <script src="bower_components/jquery-ui/ui/jquery-ui.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>
    <script src="bower_components/jassa/jassa.js"></script>
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="bower_components/ng-grid-bower/ng-grid.js"></script>
    <script src="bower_components/jassa-ui-angular/jassa-ui-angular-tpls.js"></script>
    <script src="bower_components/jassa-ui-angular-openlayers/jassa-ui-angular-openlayers-tpls.js"></script>
    <!-- endbower -->


	<script src="https://rawgithub.com/angular-ui/ng-grid/master/plugins/ng-grid-flexible-height.js"></script>

    <script src="lib/angular-ui/0.10.0/ui-bootstrap-tpls-0.10.0.js"></script>
    <script src="bower_components/underscore.string/lib/underscore.string.js"></script>
    <script src="bower_components/openlayers/lib/OpenLayers.js"></script>

<!--    <script src="js/jassa-ui-angular-geo-openlayers-tpls.js"></script> -->
	
	<script type="text/javascript">
    _.mixin(_.str.exports());

	var rdf = Jassa.rdf;
	var sparql = Jassa.sparql;
    var service = Jassa.service;
	var sponate = Jassa.sponate;
    var facete = Jassa.facete;
	var geo = Jassa.geo;
	var util = Jassa.util;
	
	var client = Jassa.client;

    var myModule = angular.module('Facete2', ['ui.bootstrap', 'ui.jassa', 'ngGrid', 'ui.jassa.openlayers']);

    myModule.controller('MyCtrl', ['$scope', '$q', '$rootScope', function($scope, $q, $rootScope) {

        /*
        {
        var sparqlService = new Jassa.service.SparqlServiceHttp('http://geostats-angular/sparql');

        sparqlService = new Jassa.service.SparqlServiceCache(sparqlService);
        sparqlService = new Jassa.service.SparqlServicePaginate(sparqlService, 1000);

        var store = new Jassa.sponate.StoreFacade(sparqlService, {
            dbo: "http://dbpedia.org/ontology/", 
            foaf: "http://xmlns.com/foaf/0.1/"
        });

        store.addMap({
            name : "entity",
            template : [{
                id : "?s",
                thumbnail : "?thumbnail",
                homepage : "?homepage"
            }],
            from : "OPTIONAL { ?s dbo:thumbnail ?thumbnail . } \
                    OPTIONAL { ?s foaf:homepage ?homepage . }"
        });
        var concept = new Jassa.facete.Concept(Jassa.sparql.ElementString.create("filter ( ?s = <" + $routeParams.uri + "> )"), Jassa.rdf.NodeFactory.createVar("s"));
        store.entity.find().concept(concept).asList().done(function(docs){

            console.log(docs);
        });
        }
        
        */
        
        
		//var sparqlService = new service.SparqlServiceHttp('http://dbpedia.org/sparql', ['http://dbpedia.org']);
		//var sparqlService = new service.SparqlServiceHttp('http://cstadler.aksw.org/conti/freebase/germany/sparql', ['http://freebase.com/2013-09-22/data/']);
		//var sparqlService = new service.SparqlServiceHttp('http://localhost:8800/sparql', ['http://localhost/geostats.virt.fixed.nt']);
		
		//var sparqlServiceIri = 'http://localhost/sparql';
		//var defaultGraphIris = ['http://localhost/geostats.nt'];

		//var sparqlServiceIri = 'http://fp7-pp.publicdata.eu/sparql';
		//var defaultGraphIris = ['http://fp7-pp.publicdata.eu/'];
		
		var sparqlServiceIri = 'http://dbpedia.org/sparql';
		var defaultGraphIris = ['http://dbpedia.org'];

		
		//var sparqlServiceIri = 'http://cstadler.aksw.org/conti/freebase/germany/sparql';
		//var defaultGraphIris = ['http://freebase.com/2013-09-22/data/'];

		var joinSummaryServiceIri = 'http://localhost:8810/sparql';
		//var joinSummaryDefaultGraphIris = ['http://dbpedia.org/2013-12-22/join-summary/'];
		var joinSummaryDefaultGraphIris = ['http://dbpedia.org/2013-12-22/join-summary-essential/'];
		
		
		//var conceptPathFinderApiUrl = 'http://localhost:8080/jassa/api/path-finding';
		var conceptPathFinderApiUrl = 'http://localhost:7532/api/path-finding';
		//var conceptPathFinderApiUrl = 'http://cstadler.aksw.org/jassa/api/path-finding';
		
		
		var sparqlService = new service.SparqlServiceHttp(sparqlServiceIri, defaultGraphIris);

		sparqlService = new service.SparqlServiceCache(sparqlService);
		sparqlService = new service.SparqlServicePaginate(sparqlService, 1000);

		
		var facetTreeConfig = new facete.FacetTreeConfig();
		var conceptFactory = new facete.ConceptFactoryFacetTreeConfig(facetTreeConfig);

		//var mapFactory =  geo.GeoMapFactoryUtils.ogcVirtMapFactory;
		var mapFactory =  geo.GeoMapFactoryUtils.wgs84MapFactory;

		
		var refresh = null;
		
		var geoConceptFactory = new facete.ConceptFactoryFacetTreeConfig(facetTreeConfig);
		
		
		
		$scope.ObjectUtils = util.ObjectUtils;
		$scope.$watch('ObjectUtils.hashCode(facetTreeConfig)', function() {
		    refresh();
		});
		

		
		$scope.setGeoPath = function(path) {
		    geoConceptFactory.setPath(path);
		}
		
		
		/*
		 * Concept Path Finding
		 */
		var refresh = function() {
						
		    var conceptPathFinder = new client.ConceptPathFinderApi(conceptPathFinderApiUrl, sparqlServiceIri, defaultGraphIris, joinSummaryServiceIri, joinSummaryDefaultGraphIris);
		    
		    var sourceConcept = conceptFactory.createConcept(); 	
			//var targetConcept = geo.GeoConcepts.conceptGeoVocab;
			var targetConcept = geo.GeoConcepts.conceptWgs84;  
			
		    var promise = conceptPathFinder.findPaths(sourceConcept, targetConcept);
			var result = sponate.angular.bridgePromise(promise, $q.defer(), $rootScope);
	
			result.then(function(paths) {
			    var tmp = _(paths).map(function(path) {			        
			        var r = {
						name: path.toString(),
						path: path
					};
			        return r;
			    });
			   
			    $scope.geoPaths = tmp;
			}, function(err) {
			    alert(err.responseText);
			});
		}
		
		
		
		

		$scope.sparqlService = sparqlService;		
        $scope.facetTreeConfig = facetTreeConfig;
        
        $scope.path = null;

        $scope.selectFacet = function(path) {
            //alert('Selected Path: [' + path + ']');
            $scope.path = path;
        };

        var facetConfig = $scope.facetTreeConfig.getFacetConfig();
        var cm = facetConfig.getConstraintManager();

/*
        cm.addConstraint(
			new facete.ConstraintSpecPathValue(
			    'equal',
			    facete.Path.parse('http://www.w3.org/1999/02/22-rdf-syntax-ns#type'),
			    rdf.NodeFactory.createUri('http://purl.org/linked-data/cube#Observation')
			)
		);
*/


       

        $scope.dataSources = [{
			sparqlService: sparqlService,
			//mapFactory: geo.GeoMapFactoryUtils.wgs84MapFactory,
			mapFactory: mapFactory,
			conceptFactory: geoConceptFactory,
		    quadTreeConfig: {
				maxItemsPerTileCount: 1000,
				maxGlobalItemCount: 2000
			}
		}];
        



		var vs = rdf.NodeFactory.createVar('s');
		var conceptFalse = new facete.Concept(sparql.ElementString.create('?s a <http://foo.bar>'), vs);

		var filterConceptFactory = new facete.ConceptFactoryConst(conceptFalse)

        $scope.selectGeom = function(data) {
            //alert('Select: ' + JSON.stringify(data));
			var node = data.id;
            var ev = new sparql.ExprVar(vs);
            var nodeValue = sparql.NodeValue.makeNode(node);
            var expr = new sparql.E_Equals(ev, nodeValue);
            var element = new sparql.ElementFilter(expr);
			var concept = new facete.Concept(element, vs);

			filterConceptFactory.setConcept(concept);

			if(!$scope.$$phase) {
                $scope.$apply();
            }
        }

        $scope.unselectGeom = function(data) {
            //alert('Unselect: ' + JSON.stringify(data));
			filterConceptFactory.setConcept(conceptFalse);
			if(!$scope.$$phase) {
                $scope.$apply();
            }
        }


		var facetConceptFactory = new facete.ConceptFactoryFacetConfig(facetConfig);

        var dataConcept = facete.ConceptUtils.createSubjectConcept(vs);
        var elementFactory = new sparql.ElementFactoryJoinConcept(new facete.ConceptFactoryConst(dataConcept), filterConceptFactory);
            
        var tableMod = new facete.TableMod();
        var queryFactory = new facete.QueryFactoryTableMod(elementFactory, tableMod);

        //tableMod.addColumn('s');
        tableMod.addColumn('_p_');
        tableMod.addColumn('_o_');

		$scope.facetTableConfig = {
			queryFactory: queryFactory,
			tableMod: tableMod
		};

    }]);
	</script>

</head>

<body ng-controller="MyCtrl">

	<div style="position: absolute; top: 0px; left: 0px; width: 500px; max-height: 100%; overflow: auto; margin: 5px;">

		<div class="panel panel-info"> 
			<div class="panel-heading">
				<i class="panel-title">GeoPaths</i>
			</div>
			<div class="panel-body">
   				<ul>
   					<li ng-repeat="geoPath in geoPaths"><a href="" ng-click="setGeoPath(geoPath.path)">{{geoPath.name}}</a></li>
   				</ul>
			</div>
		</div>


		<div class="panel panel-info"> 
			<div class="panel-heading">
				<i class="panel-title">Facet Tree</i>
			</div>
			<div class="panel-body">
			   <facet-tree sparql-service="sparqlService" facet-tree-config="facetTreeConfig" select="selectFacet(path)"></facet-tree>
			</div>
		</div>

		<div class="panel panel-info"> 
			<div class="panel-heading">
				<i class="panel-title">Facet Values</i>
			</div>
			<div class="panel-body">
   				<facet-value-list sparql-service="sparqlService" facet-tree-config="facetTreeConfig" path="path"></facet-value-list>
			</div>
		</div>

		<div class="panel panel-info"> 
			<div class="panel-heading">
				<i class="panel-title">Constraints</i>
			</div>
			<div class="panel-body">
   				<constraint-list sparql-service="sparqlService" facet-tree-config="facetTreeConfig"></constraint-list>
			</div>
		</div>

	</div>

	<div class="panel panel-info" style="display: none; position: absolute; bottom: 30px; left: 520px; height: 500px"> 
		<div class="panel-heading">
			<i class="panel-title">Data</i>
		</div>
		<div class="panel-body">
			<sparql-table sparql-service="sparqlService" config="facetTableConfig"></sparql-table>
		</div>
	</div>


    <div jassa-map-ol="map" style="position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; z-index:-9999" config="dataSources" select="selectGeom(data)" unselect="unselectGeom(data)"></div>

</body>

</html>

